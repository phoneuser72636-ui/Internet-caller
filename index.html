<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CYBER_PROTOCOL // ELITE_V4</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root { --neon: #00f2ff; --warn: #ff0055; --safe: #00ff88; --void: #050505; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--void); color: var(--neon); font-family: 'Share Tech Mono', monospace; overflow: hidden; }
        
        /* Scanline & Purge Glitch */
        .scanline { position: fixed; inset: 0; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%); background-size: 100% 4px; pointer-events: none; z-index: 1000; }
        #purge-fx { display: none; position: fixed; inset: 0; z-index: 3000; animation: glitch-purge 0.1s infinite; }
        @keyframes glitch-purge { 0% { background: var(--warn); clip-path: inset(10% 0 30% 0); } 50% { background: var(--neon); transform: scale(1.1) skew(5deg); } 100% { background: #fff; } }

        /* Auth Gate */
        #auth-gate { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: #000; z-index: 2000; padding: 20px; }
        .auth-box { width: 100%; max-width: 420px; border: 1px solid var(--neon); padding: 40px; box-shadow: 0 0 30px rgba(0, 242, 255, 0.3); background: #000; text-align: center; }
        .auth-input { width: 100%; padding: 15px; background: #000; border: 1px solid var(--neon); color: var(--neon); margin-bottom: 20px; font-family: inherit; font-size: 1rem; }

        /* App Layout */
        #app-shell { display: none; height: 100vh; width: 100vw; position: relative; }

        /* Sidebar Navigation */
        #sidebar { width: 100%; height: 100%; border-right: 1px solid var(--neon); display: flex; flex-direction: column; background: #000; position: absolute; z-index: 500; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .side-head { padding: 25px 20px; border-bottom: 1px solid var(--neon); display: flex; justify-content: space-between; align-items: center; font-weight: bold; letter-spacing: 2px; }
        #node-list { flex: 1; overflow-y: auto; padding: 15px; }
        .node { padding: 20px; border: 1px solid rgba(0, 242, 255, 0.2); margin-bottom: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .node.active-node { border-color: var(--safe); box-shadow: inset 0 0 15px rgba(0, 255, 136, 0.1); }

        /* Chat Workspace */
        #workspace { width: 100%; height: 100%; display: flex; flex-direction: column; background: var(--void); transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: absolute; z-index: 600; }
        #workspace.active { transform: translateX(0); }
        #chat-header { padding: 15px 20px; border-bottom: 1px solid var(--neon); display: flex; align-items: center; background: #000; justify-content: space-between; }
        #chat-flow { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 15px; background-image: linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px); background-size: 25px 25px; }

        /* Messaging */
        .msg { padding: 14px 18px; border: 1px solid rgba(0, 242, 255, 0.3); max-width: 85%; position: relative; word-break: break-all; }
        .sent { align-self: flex-end; border-right: 4px solid var(--neon); background: rgba(0, 242, 255, 0.05); }
        .received { align-self: flex-start; border-left: 4px solid var(--warn); color: var(--warn); border-color: var(--warn); }
        .msg-info { font-size: 9px; margin-top: 6px; display: flex; justify-content: flex-end; gap: 5px; opacity: 0.6; }
        .read-tick { color: var(--safe); font-weight: bold; }

        /* Input Controls */
        #deck { padding: 15px; background: #000; border-top: 1px solid var(--neon); display: flex; align-items: center; gap: 12px; }
        .btn-icon { width: 45px; height: 45px; border: 1px solid var(--neon); display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--neon); background: none; font-size: 1.5rem; }
        #msg-in { flex: 1; background: #0a0a0a; border: 1px solid var(--neon); color: var(--neon); padding: 12px; font-family: inherit; }
        .btn-send { background: var(--neon); color: #000; padding: 0 20px; height: 45px; font-weight: bold; border: none; letter-spacing: 1px; }

        .media-box { max-width: 100%; border: 1px solid var(--neon); margin-top: 8px; cursor: pointer; display: block; }
    </style>
</head>
<body>
    <div class="scanline"></div>
    <div id="purge-fx"></div>

    <div id="auth-gate">
        <div class="auth-box">
            <h1 style="letter-spacing: 6px; margin-bottom: 30px;">PROTOCOL_ACCESS</h1>
            <input type="text" id="user_id" class="auth-input" placeholder="NODE_USERNAME">
            <input type="password" id="pass_phrase" class="auth-input" placeholder="ACCESS_PASSWORD">
            <button onclick="auth()" style="width: 100%; background: var(--neon); color: #000; padding: 18px; font-weight: bold; border: none; cursor: pointer;">INITIALIZE_AUTHENTICATION</button>
            <p id="auth-err" style="color: var(--warn); font-size: 11px; margin-top: 20px;"></p>
        </div>
    </div>

    <div id="app-shell">
        <div id="sidebar">
            <div class="side-head">
                <span>ACTIVE_NODES</span>
                <button onclick="terminate()" style="color: var(--warn); background: none; border: 1px solid var(--warn); padding: 5px 12px; font-size: 10px; cursor: pointer;">TERMINATE</button>
            </div>
            <div id="node-list"></div>
            <div style="padding: 15px; border-top: 1px solid var(--neon); font-size: 11px; opacity: 0.5;">
                LOCAL_ID: <span id="my-id"></span>
            </div>
        </div>

        <div id="workspace">
            <div id="chat-header">
                <button onclick="exitChat()" style="background: none; color: var(--neon); border: 1px solid var(--neon); padding: 6px 12px; cursor: pointer;">[BACK]</button>
                <div style="text-align: center;">
                    <span id="target-label" style="font-weight: bold; letter-spacing: 2px;">...</span><br>
                    <span id="typing-label" style="font-size: 9px; color: var(--safe); height: 12px; display: block;"></span>
                </div>
                <button onclick="nuclearPurge()" style="background: none; border: 1px solid var(--warn); color: var(--warn); padding: 6px 12px; font-size: 10px; cursor: pointer;">PURGE</button>
            </div>
            
            <div id="chat-flow"></div>

            <div id="deck">
                <button class="btn-icon" onclick="openUplink()">+</button>
                <input type="text" id="msg-in" placeholder="ENCRYPT_DATA..." oninput="emitTyping()">
                <button class="btn-send" onclick="dispatch()">SEND</button>
            </div>
            <input type="file" id="uplink" style="display: none;" onchange="handleUplink(this)">
        </div>
    </div>

    <script>
        const socket = io();
        const AES_KEY = "PROTOCOL_MASTER_V4";
        let session = null;
        let activePeer = null;
        let tOut;

        // Auto-Login Implementation
        window.onload = () => {
            const vault = localStorage.getItem('cyber_v4_vault');
            if(vault) {
                session = JSON.parse(vault);
                boot();
            }
        };

        function auth() {
            const u = document.getElementById('user_id').value;
            const p = document.getElementById('pass_phrase').value;
            if(!u || !p) return;

            // Password Protection (SHA-256)
            const token = CryptoJS.SHA256(p).toString();
            session = { user: u, token: token };
            localStorage.setItem('cyber_v4_vault', JSON.stringify(session));
            boot();
        }

        function boot() {
            document.getElementById('auth-gate').style.display = 'none';
            document.getElementById('app-shell').style.display = 'flex';
            document.getElementById('my-id').innerText = session.user;
            socket.emit('node_handshake', { user: session.user, token: session.token });
            syncDirectory(); 
        }

        function terminate() {
            localStorage.removeItem('cyber_v4_vault');
            window.location.reload();
        }

        // Navigation
        function enterChat(peer) {
            activePeer = peer;
            document.getElementById('target-label').innerText = `NODE: ${peer}`;
            document.getElementById('workspace').classList.add('active');
            socket.emit('peer_view', { from: session.user, to: peer });
        }

        function exitChat() {
            document.getElementById('workspace').classList.remove('active');
            activePeer = null;
        }

        // Secure Messaging
        function dispatch() {
            const input = document.getElementById('msg-in');
            if(!input.value || !activePeer) return;

            const packet = {
                pid: 'p_' + Date.now(),
                from: session.user,
                to: activePeer,
                payload: CryptoJS.AES.encrypt(input.value, AES_KEY).toString(),
                stamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            };

            socket.emit('secure_broadcast', packet);
            append(packet, true);
            input.value = '';
        }

        function append(pkt, isMe) {
            const flow = document.getElementById('chat-flow');
            const div = document.createElement('div');
            div.id = pkt.pid;
            div.className = `msg ${isMe ? 'sent' : 'received'}`;
            
            let data = CryptoJS.AES.decrypt(pkt.payload, AES_KEY).toString(CryptoJS.enc.Utf8);
            
            // Media Rendering
            if(data.match(/\.(jpg|jpeg|png|gif)$/i)) data = `<img src="${data}" class="media-box" onclick="window.open(this.src)">`;
            else if(data.match(/\.(mp4|webm)$/i)) data = `<video src="${data}" controls class="media-box"></video>`;

            const ticks = isMe ? `<span class="read-tick" id="seen_${pkt.pid}">✓</span>` : '';
            div.innerHTML = `<div>${data}</div><div class="msg-info">${pkt.stamp} ${ticks}</div>`;
            
            flow.appendChild(div);
            flow.scrollTop = flow.scrollHeight;

            if(!isMe && activePeer === pkt.from) {
                socket.emit('mark_seen', { from: session.user, to: pkt.from, pid: pkt.pid });
            }
        }

        // Real-Time Sync
        socket.on('broadcast_receive', (p) => { if(activePeer === p.from) append(p, false); });
        
        socket.on('seen_confirmed', (d) => {
            const tick = document.getElementById(`seen_${d.pid}`);
            if(tick) { tick.innerText = '✓✓'; tick.style.color = 'var(--safe)'; }
        });

        function emitTyping() {
            socket.emit('peer_typing', { from: session.user, to: activePeer });
            clearTimeout(tOut);
            tOut = setTimeout(() => socket.emit('peer_typing_stop', { to: activePeer }), 1500);
        }

        socket.on('is_typing', (d) => { if(activePeer === d.from) document.getElementById('typing-label').innerText = "DECRYPTING_DATA_STREAM..."; });
        socket.on('no_typing', () => { document.getElementById('typing-label').innerText = ""; });

        // Purge & Attachments
        function nuclearPurge() { socket.emit('purge_req', { u1: session.user, u2: activePeer }); }
        
        socket.on('start_purge', () => {
            document.getElementById('purge-fx').style.display = 'block';
            setTimeout(() => {
                document.getElementById('chat-flow').innerHTML = '';
                document.getElementById('purge-fx').style.display = 'none';
            }, 2000);
        });

        function openUplink() { document.getElementById('uplink').click(); }
        function handleUplink(el) {
            const file = el.files[0];
            const reader = new FileReader();
            reader.onloadend = () => {
                const pkt = {
                    pid: 'p_' + Date.now(),
                    from: session.user,
                    to: activePeer,
                    payload: CryptoJS.AES.encrypt(reader.result, AES_KEY).toString(),
                    stamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                };
                socket.emit('secure_broadcast', pkt);
                append(pkt, true);
            };
            if(file) reader.readAsDataURL(file);
        }

        // Directory Sync
        function syncDirectory() {
            const list = document.getElementById('node-list');
            list.innerHTML = '';
            // In a production server, this list is received via 'directory_update' socket event
            ['System_Admin', 'Ninja_Elite', 'Ghost_Protocol', 'Shadow_Node'].forEach(u => {
                if(u === session.user) return;
                const d = document.createElement('div');
                d.className = 'node';
                d.innerHTML = `<span>${u}</span><span style="font-size:9px; color:var(--safe)">LINK_ACTIVE</span>`;
                d.onclick = () => enterChat(u);
                list.appendChild(d);
            });
        }
    </script>
</body>
</html>
