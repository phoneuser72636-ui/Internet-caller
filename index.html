<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RADIOTALKER // CYBER_OS</title>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignal = window.OneSignal || [];
      OneSignal.push(() => { 
          OneSignal.init({ 
              appId: "c00af28f-f943-4a78-aa65-1629d000bbab", 
              allowLocalhostAsSecureOrigin: true,
              persistNotification: true 
          }); 
      });
    </script>

    <style>
        :root { --pink: #ff0055; --blue: #00f2ff; --bg: #050505; }
        body { 
            background: black url('https://wallpaperaccess.com/full/1324706.jpg') no-repeat center center fixed; 
            background-size: cover; color: white; font-family: 'Courier New', monospace; margin: 0; overflow: hidden; 
        }
        
        .scanlines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%); background-size: 100% 4px; pointer-events: none; z-index: 100; opacity: 0.2; }

        /* Full Screen Call UI */
        #call-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; border: 4px solid var(--blue); box-shadow: 0 0 30px var(--blue); }
        
        .os-container { height: 100vh; display: grid; grid-template-columns: 75px 1fr; border: 4px solid var(--pink); box-sizing: border-box; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); }
        .sidebar { border-right: 2px solid var(--pink); display: flex; flex-direction: column; padding: 5px; background: rgba(0,0,0,0.9); }
        .friend-circle { width: 48px; height: 48px; border: 2px solid var(--blue); border-radius: 50%; margin: 12px auto; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; background: black; transition: 0.2s; }
        .status-dot { position: absolute; bottom: 2px; right: 2px; width: 11px; height: 11px; border-radius: 50%; border: 1.5px solid black; }
        .online { background: #00ff00; box-shadow: 0 0 8px #00ff00; }
        .offline { background: #ff0000; }

        #splash, #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 500; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .header { padding: 14px; border-bottom: 2px solid var(--pink); display: flex; justify-content: space-between; font-size: 11px; background: black; }
        .main-view { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        #chat-window { flex: 1; display: none; flex-direction: column; background: rgba(0,0,0,0.8); }
        
        .cyber-btn { background: transparent; color: var(--pink); border: 2px solid var(--pink); padding: 10px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 11px; }
        .accept-btn { border-color: #00ff00; color: #00ff00; box-shadow: 0 0 15px #00ff00; width: 220px; margin-bottom: 20px; font-size: 14px; }
        .decline-btn { border-color: var(--pink); color: var(--pink); width: 220px; }
    </style>
</head>
<body>

<div class="scanlines"></div>

<div id="call-modal">
    <div style="font-size: 10px; color: var(--blue); margin-bottom: 10px;">INCOMING_ENCRYPTED_UPLINK</div>
    <h2 id="caller-name" style="color: white; text-shadow: 0 0 10px var(--blue); letter-spacing: 5px;">---</h2>
    <div id="call-type" style="color: var(--blue); margin-bottom: 40px; font-size: 12px;">SIGNALING...</div>
    <button class="cyber-btn accept-btn" onclick="acceptCall()">ACCEPT_UPLINK</button>
    <button class="cyber-btn decline-btn" onclick="rejectCall()">TERMINATE</button>
</div>

<div id="splash">RECONNECTING_UPLINK_BUFFERS...</div>

<div id="auth-overlay" style="display:none;">
    <h2 style="color: var(--pink);">IDENTITY_ACCESS</h2>
    <div style="width: 80%; max-width: 300px; display: flex; flex-direction: column; gap: 15px;">
        <input type="text" id="auth-user" placeholder="USERNAME" style="border: 1px solid var(--blue); background: black; color: white; padding: 12px;">
        <input type="password" id="auth-pass" placeholder="PASSWORD" style="border: 1px solid var(--blue); background: black; color: white; padding: 12px;">
        <button class="cyber-btn" onclick="handleAuth()">INITIALIZE</button>
    </div>
</div>

<div class="os-container">
    <div class="sidebar">
        <div id="friends-list"></div>
        <button class="cyber-btn" onclick="document.getElementById('ring-picker').click()" style="margin-top:auto; font-size:7px;">SET_RING</button>
        <input type="file" id="ring-picker" hidden onchange="saveRing(this)">
    </div>
    <div class="main-view">
        <div class="header">
            <span id="user-display">OS_OFFLINE</span>
            <span onclick="logout()" style="color: var(--pink); cursor: pointer; font-weight:bold;">[LOGOUT]</span>
        </div>
        <div id="init-screen" style="padding: 20px;">
            <input type="text" id="target-user" placeholder="SEARCH_IDENTITY..." style="border-bottom: 2px solid var(--blue); width: 100%; background:transparent; color:var(--blue); padding:10px;">
            <button class="cyber-btn" onclick="sendFriendRequest()" style="width: 100%; margin-top: 15px;">ADD_FRIEND</button>
            <div id="req-list" style="margin-top: 25px;"></div>
        </div>
        <div id="chat-window">
            <div style="display:flex; justify-content: space-around; padding:12px; border-bottom:1px solid var(--blue); background:rgba(0,242,255,0.05);">
                <button class="cyber-btn" style="color: #00ff00; border-color: #00ff00;" onclick="triggerCall('VOICE')">VOICE</button>
                <button class="cyber-btn" style="color: var(--blue); border-color: var(--blue);" onclick="triggerCall('VIDEO')">VIDEO</button>
                <button class="cyber-btn" onclick="exitChat()">BACK</button>
            </div>
            <div id="messages"></div>
            <div style="display:flex; border-top:2px solid var(--blue); background:black; padding:10px;">
                <input type="text" id="msg-input" placeholder="DATA_STREAM...">
                <button class="cyber-btn" onclick="sendMessage()">SEND</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue, remove, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD2WRzWp0pl2niRizDPF_kqUrHB4_gY8gA",
        authDomain: "radio-c49c0.firebaseapp.com",
        databaseURL: "https://radio-c49c0-default-rtdb.firebaseio.com",
        projectId: "radio-c49c0",
        messagingSenderId: "231017755170",
        appId: "1:231017755170:web:02df1616290fe2edcdd07b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let currentUid = "", currentUsername = "", partnerUid = "";
    let ringtone = new Audio();
    const chirp = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
    let activeCallData = null;
    let callInterval = null;

    // WHATSAPP PERSISTENCE HANDSHAKE
    onAuthStateChanged(auth, async (user) => { 
        if (!user) await signInAnonymously(auth);
        const saved = localStorage.getItem('rt_session');
        if (saved) {
            const data = JSON.parse(saved);
            login(data.u, data.uid);
            document.getElementById('splash').style.display = 'none';
        } else {
            document.getElementById('splash').style.display = 'none';
            document.getElementById('auth-overlay').style.display = 'flex';
        }
    });

    window.handleAuth = async () => {
        const u = document.getElementById('auth-user').value.toLowerCase().trim();
        const p = document.getElementById('auth-pass').value.trim();
        const snap = await get(ref(db, `users/${u}`));
        if(snap.exists() && snap.val().password !== p) return alert("BAD_KEY");
        const uid = snap.exists() ? snap.val().uid : auth.currentUser.uid;
        if(!snap.exists()) await set(ref(db, `users/${u}`), { uid, password: p });
        localStorage.setItem('rt_session', JSON.stringify({u: u, uid: uid}));
        login(u, uid);
    };

    function login(u, uid) {
        currentUsername = u; currentUid = uid;
        document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('user-display').innerText = `ID: ${u.toUpperCase()}`;
        onDisconnect(ref(db, `status/${uid}`)).set({ state: "offline" });
        set(ref(db, `status/${uid}`), { state: "online" });
        listenFriends(); listenRequests(); listenCalls();
        window.OneSignal.push(() => OneSignal.setExternalUserId(uid));
    }

    // CONTINUOUS BEEP/RING LOGIC
    function listenCalls() {
        onValue(ref(db, `calls/${currentUid}`), (snap) => {
            if (snap.exists()) {
                activeCallData = snap.val();
                document.getElementById('caller-name').innerText = activeCallData.from.toUpperCase();
                document.getElementById('call-type').innerText = `${activeCallData.type}_UPLINK_REQUESTED`;
                document.getElementById('call-modal').style.display = 'flex';
                
                // Start Continuous Ringing
                if (!callInterval) {
                    const playRing = () => { if(localStorage.getItem('rt_ring')) ringtone.play(); else chirp.play(); };
                    playRing();
                    callInterval = setInterval(playRing, 2000);
                }
            }
        });
    }

    window.acceptCall = () => {
        clearInterval(callInterval); callInterval = null;
        document.getElementById('call-modal').style.display = 'none';
        openChat(activeCallData.from, activeCallData.fromUid);
        remove(ref(db, `calls/${currentUid}`));
    };

    window.rejectCall = () => {
        clearInterval(callInterval); callInterval = null;
        document.getElementById('call-modal').style.display = 'none';
        remove(ref(db, `calls/${currentUid}`));
    };

    window.triggerCall = (type) => {
        // High-Priority OneSignal Push
        fetch("https://onesignal.com/api/v1/notifications", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                app_id: "c00af28f-f943-4a78-aa65-1629d000bbab",
                include_external_user_ids: [partnerUid],
                priority: 10,
                headings: {"en": `INCOMING ${type}`},
                contents: {"en": `${currentUsername.toUpperCase()} IS SIGNALING... TAP TO ANSWER.`}
            })
        });
        set(ref(db, `calls/${partnerUid}`), { from: currentUsername, fromUid: currentUid, type: type });
    };

    window.sendMessage = () => {
        const text = document.getElementById('msg-input').value; if(!text || !partnerUid) return;
        const chatId = currentUid < partnerUid ? `${currentUid}_${partnerUid}` : `${partnerUid}_${currentUid}`;
        push(ref(db, `chats/${chatId}`), { sender: currentUid, text });
        
        // Single Beep Notification
        fetch("https://onesignal.com/api/v1/notifications", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                app_id: "c00af28f-f943-4a78-aa65-1629d000bbab",
                include_external_user_ids: [partnerUid],
                headings: {"en": `${currentUsername.toUpperCase()}`},
                contents: {"en": "DATA_PACKET_RECEIVED."}
            })
        });
        document.getElementById('msg-input').value = '';
    };

    function listenFriends() {
        onValue(ref(db, `friends/${currentUid}`), (snap) => {
            const list = document.getElementById('friends-list'); list.innerHTML = '';
            snap.forEach((child) => {
                const f = child.val();
                const div = document.createElement('div');
                div.className = 'friend-circle';
                div.innerHTML = `<span style="font-size:12px; font-weight:bold;">${f.name.substring(0,2).toUpperCase()}</span><div id="dot-${child.key}" class="status-dot offline"></div>`;
                div.onclick = () => openChat(f.name, child.key);
                list.appendChild(div);
                onValue(ref(db, `status/${child.key}`), (s) => {
                    const dot = document.getElementById(`dot-${child.key}`);
                    if(dot) dot.className = `status-dot ${s.val()?.state === 'online' ? 'online' : 'offline'}`;
                });
            });
        });
    }

    function openChat(name, uid) {
        partnerUid = uid;
        document.getElementById('init-screen').style.display = 'none';
        document.getElementById('chat-window').style.display = 'flex';
        document.getElementById('user-display').innerText = `CHANNEL: ${name.toUpperCase()}`;
        const chatId = currentUid < uid ? `${currentUid}_${uid}` : `${uid}_${currentUid}`;
        onValue(ref(db, `chats/${chatId}`), (s) => {
            const box = document.getElementById('messages'); box.innerHTML = '';
            s.forEach((m) => {
                const d = document.createElement('div');
                d.className = m.val().sender === currentUid ? 'msg me' : 'msg them';
                d.innerText = m.val().text; box.appendChild(d);
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    window.exitChat = () => { document.getElementById('chat-window').style.display = 'none'; document.getElementById('init-screen').style.display = 'block'; partnerUid = ""; };
    window.logout = () => { localStorage.clear(); location.reload(); };
    window.saveRing = (i) => {
        const reader = new FileReader();
        reader.onload = (e) => { localStorage.setItem('rt_ring', e.target.result); ringtone.src = e.target.result; };
        reader.readAsDataURL(i.files[0]);
    };
    window.sendFriendRequest = async () => {
        const t = document.getElementById('target-user').value.toLowerCase().trim();
        if(t === currentUsername) return;
        const snap = await get(ref(db, `users/${t}`));
        if(!snap.exists()) return alert("SIGNAL_LOST");
        set(ref(db, `requests/${snap.val().uid}/${currentUid}`), { from: currentUsername, fromUid: currentUid });
    };
    function listenRequests() {
        onValue(ref(db, `requests/${currentUid}`), (snap) => {
            const list = document.getElementById('req-list'); list.innerHTML = '';
            snap.forEach((child) => {
                const r = child.val();
                const div = document.createElement('div');
                div.innerHTML = `<span style="font-size:11px;">REQ: ${r.from}</span> <button class="cyber-btn" onclick="acceptFriend('${r.from}','${r.fromUid}')">ACCEPT</button>`;
                list.appendChild(div);
                chirp.play();
            });
        });
    }
    window.acceptFriend = async (n, u) => {
        await set(ref(db, `friends/${currentUid}/${u}`), { name: n });
        await set(ref(db, `friends/${u}/${currentUid}`), { name: currentUsername });
        remove(ref(db, `requests/${currentUid}/${u}`));
    };
</script>
</body>
</html>
