<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RADIOTALKER // CYBER_OS</title>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignal = window.OneSignal || [];
      OneSignal.push(() => { OneSignal.init({ appId: "c00af28f-f943-4a78-aa65-1629d000bbab", allowLocalhostAsSecureOrigin: true }); });
    </script>

    <style>
        :root { --pink: #ff0055; --blue: #00f2ff; --bg: #050505; }
        body { background: black url('https://wallpaperaccess.com/full/1324706.jpg') no-repeat center center fixed; background-size: cover; color: white; font-family: 'Courier New', monospace; margin: 0; overflow: hidden; height: 100vh; }
        
        #glitch-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: none; align-items: center; justify-content: center; color: black; font-weight: bold; animation: glitchSync 0.2s infinite; }
        @keyframes glitchSync { 0% { background: var(--pink); transform: skew(2deg); } 50% { background: var(--blue); transform: skew(-2deg); } 100% { background: white; } }

        #call-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; border: 4px solid var(--blue); }
        .timer { font-size: 28px; color: var(--blue); margin: 20px 0; text-shadow: 0 0 10px var(--blue); }

        .os-container { height: 100vh; display: grid; grid-template-columns: 75px 1fr; border: 4px solid var(--pink); box-sizing: border-box; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); position: relative; }
        .sidebar { border-right: 2px solid var(--pink); display: flex; flex-direction: column; padding: 5px; height: 100%; background: rgba(0,0,0,0.9); }
        
        #chat-window { flex: 1; display: none; flex-direction: column; height: 100%; position: relative; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; font-size: 14px; display: flex; flex-direction: column; padding-bottom: 100px; }
        
        /* WhatsApp-Style Input with [+] Button */
        .input-dock { position: absolute; bottom: 0; left: 0; width: 100%; display: flex; align-items: center; border-top: 2px solid var(--blue); background: black; padding: 10px; box-sizing: border-box; }
        .plus-btn { color: var(--blue); border: 2px solid var(--blue); border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; margin-right: 10px; }
        input { background: transparent; border: none; color: var(--blue); padding: 12px; flex: 1; outline: none; font-size: 16px; font-family: 'Courier New'; }
        
        .cyber-btn { background: transparent; color: var(--pink); border: 2px solid var(--pink); padding: 8px 12px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 10px; }
        .msg { margin-bottom: 10px; padding: 12px; border-radius: 5px; max-width: 80%; border: 1px solid transparent; word-wrap: break-word; }
        .msg.me { align-self: flex-end; border-color: var(--blue); color: var(--blue); }
        .msg.them { align-self: flex-start; border-color: var(--pink); color: var(--pink); }
        .media-link { color: #00ff00; text-decoration: underline; font-size: 12px; display: block; margin-top: 5px; }
    </style>
</head>
<body>

<div id="glitch-overlay">UPLINK_TERMINATED</div>
<div id="call-screen">
    <div style="font-size: 10px; color: var(--blue); letter-spacing: 2px;">SECURE_VOICE_UPLINK</div>
    <h2 id="caller-display" style="color: white; margin-top: 20px; letter-spacing: 5px;">---</h2>
    <div id="call-timer" class="timer">00:00</div>
    <div style="display:flex; flex-direction:column; gap:20px;">
        <button id="ans-btn" class="cyber-btn" style="color:#00ff00; border-color:#00ff00; width:220px;" onclick="acceptAudioUplink()">ACCEPT_LINK</button>
        <button class="cyber-btn" style="color:#ff0000; border-color:#ff0000; width:220px;" onclick="terminateAudioUplink()">TERMINATE</button>
    </div>
</div>

<div class="os-container">
    <div class="sidebar"><div id="friends-list"></div></div>
    <div class="main-view" style="display: flex; flex-direction: column; height: 100%; overflow: hidden;">
        <div class="header" style="padding: 14px; border-bottom: 2px solid var(--pink); display: flex; justify-content: space-between; font-size: 11px; background: black;">
            <span id="user-display">OS_OFFLINE</span>
            <span onclick="logout()" style="color: var(--pink); cursor: pointer; font-weight:bold;">[LOGOUT]</span>
        </div>
        <div id="init-screen" style="padding: 20px;">
            <input type="text" id="target-user" placeholder="TARGET_ID..." style="border-bottom: 2px solid var(--blue); width: 100%; background:transparent; color:var(--blue); padding:10px;">
            <button class="cyber-btn" onclick="sendFriendRequest()" style="width: 100%; margin-top: 15px;">TRANSMIT_ADD</button>
            <div id="req-list" style="margin-top: 25px;"></div>
        </div>
        <div id="chat-window">
            <div style="display:flex; justify-content: space-around; padding:12px; border-bottom:1px solid var(--blue); background:rgba(0,242,255,0.05);">
                <button class="cyber-btn" style="color:#00ff00; border-color:#00ff00;" onclick="initiateCall('VOICE')">VOICE</button>
                <button class="cyber-btn" style="color:#ffff00; border-color:#ffff00;" onclick="triggerDestruct()">DESTROY</button>
                <button class="cyber-btn" onclick="exitChat()">EXIT</button>
            </div>
            <div id="messages"></div>
            <div class="input-dock" id="bottom-dock">
                <div class="plus-btn" onclick="document.getElementById('file-input').click()">+</div>
                <input type="file" id="file-input" hidden onchange="transmitMedia(this)">
                <input type="text" id="msg-input" placeholder="SECURE_INPUT...">
                <button class="cyber-btn" onclick="sendMessage()">SEND</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue, remove, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD2WRzWp0pl2niRizDPF_kqUrHB4_gY8gA",
        authDomain: "radio-c49c0.firebaseapp.com",
        databaseURL: "https://radio-c49c0-default-rtdb.firebaseio.com",
        projectId: "radio-c49c0",
        messagingSenderId: "231017755170",
        appId: "1:231017755170:web:02df1616290fe2edcdd07b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let currentUid = "", currentUsername = "", partnerUid = "", callTimer = null;
    let ringtone = new Audio();
    const chirp = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

    onAuthStateChanged(auth, async (user) => { 
        if (!user) await signInAnonymously(auth);
        const saved = localStorage.getItem('rt_session');
        if (saved) { login(JSON.parse(saved).u, JSON.parse(saved).uid); }
        else { document.getElementById('init-screen').style.display = 'block'; }
    });

    function login(u, uid) {
        currentUsername = u; currentUid = uid;
        document.getElementById('user-display').innerText = `ID: ${u.toUpperCase()}`;
        onDisconnect(ref(db, `status/${uid}`)).set({ state: "offline" });
        set(ref(db, `status/${uid}`), { state: "online" });
        listenFriends(); listenRequests(); listenSignals();
        window.OneSignal.push(() => OneSignal.setExternalUserId(uid));
    }

    // 1. DUAL-SIDE VOICE LOGIC
    function listenSignals() {
        onValue(ref(db, `signals/${currentUid}`), (snap) => {
            if (snap.exists()) {
                const signal = snap.val();
                // A. Mutual Accepted Signal: Switches Caller side to timer UI
                if (signal.type === 'ACCEPTED') {
                    startUplinkTimer();
                } 
                // B. Incoming Call Signal: Opens Modal for Receiver
                else if (signal.type === 'VOICE') {
                    document.getElementById('caller-display').innerText = signal.from.toUpperCase();
                    document.getElementById('call-screen').style.display = 'flex';
                    document.getElementById('ans-btn').style.display = 'block';
                    if(localStorage.getItem('rt_ring')) ringtone.play(); else chirp.play();
                }
            }
        });
    }

    window.initiateCall = (type) => {
        set(ref(db, `signals/${partnerUid}`), { from: currentUsername, fromUid: currentUid, type: type });
        document.getElementById('caller-display').innerText = `CALLING_${partnerUid.substring(0,5)}...`;
        document.getElementById('call-screen').style.display = 'flex';
        document.getElementById('ans-btn').style.display = 'none'; // Caller waits
    };

    window.acceptAudioUplink = async () => {
        ringtone.pause();
        // Force Mic Permission Handshake
        try { await navigator.mediaDevices.getUserMedia({ audio: true }); } catch(e) { alert("MIC_REQUIRED"); }
        // Signal caller to also switch to timer UI
        await set(ref(db, `signals/${partnerUid}`), { type: 'ACCEPTED' });
        startUplinkTimer();
    };

    function startUplinkTimer() {
        let sec = 0;
        document.getElementById('ans-btn').style.display = 'none';
        callTimer = setInterval(() => {
            sec++;
            let m = Math.floor(sec/60).toString().padStart(2,'0');
            let s = (sec%60).toString().padStart(2,'0');
            document.getElementById('call-timer').innerText = `${m}:${s}`;
        }, 1000);
    }

    window.terminateAudioUplink = () => {
        clearInterval(callTimer); ringtone.pause();
        document.getElementById('call-screen').style.display = 'none';
        remove(ref(db, `signals/${currentUid}`));
        remove(ref(db, `signals/${partnerUid}`));
    };

    // 2. MEDIA TRANSMISSION [+] FEATURE
    window.transmitMedia = async (input) => {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const mediaData = e.target.result;
            const chatId = currentUid < partnerUid ? `${currentUid}_${partnerUid}` : `${partnerUid}_${currentUid}`;
            push(ref(db, `chats/${chatId}`), { 
                sender: currentUid, 
                text: `[MEDIA_PACKET]: ${file.name}`, 
                file: mediaData,
                fileName: file.name 
            });
        };
        reader.readAsDataURL(file);
    };

    // 3. MUTUAL DESTRUCTION
    window.triggerDestruct = async () => {
        const chatId = currentUid < partnerUid ? `${currentUid}_${partnerUid}` : `${partnerUid}_${currentUid}`;
        document.getElementById('messages').innerHTML = "";
        await set(ref(db, `destruct/${chatId}/${currentUid}`), true);
    };

    function listenDestruct(chatId) {
        onValue(ref(db, `destruct/${chatId}`), (snap) => {
            if (snap.exists() && Object.keys(snap.val()).length >= 2) {
                document.getElementById('glitch-overlay').style.display = 'flex';
                remove(ref(db, `chats/${chatId}`));
                remove(ref(db, `destruct/${chatId}`));
                setTimeout(() => { document.getElementById('glitch-overlay').style.display = 'none'; exitChat(); }, 2000);
            }
        });
    }

    // CORE UI
    function openChat(name, uid) {
        partnerUid = uid; document.getElementById('init-screen').style.display = 'none'; document.getElementById('chat-window').style.display = 'flex';
        const chatId = currentUid < uid ? `${currentUid}_${uid}` : `${uid}_${currentUid}`;
        listenDestruct(chatId);
        onValue(ref(db, `chats/${chatId}`), (s) => {
            const box = document.getElementById('messages'); box.innerHTML = '';
            s.forEach((m) => {
                const data = m.val();
                const d = document.createElement('div');
                d.className = data.sender === currentUid ? 'msg me' : 'msg them';
                d.innerHTML = `> ${data.text}`;
                if(data.file) d.innerHTML += `<a href="${data.file}" download="${data.fileName}" class="media-link">DOWNLOAD_DATA</a>`;
                box.appendChild(d);
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    window.sendMessage = () => {
        const text = document.getElementById('msg-input').value; if(!text || !partnerUid) return;
        const chatId = currentUid < partnerUid ? `${currentUid}_${partnerUid}` : `${partnerUid}_${currentUid}`;
        push(ref(db, `chats/${chatId}`), { sender: currentUid, text });
        document.getElementById('msg-input').value = '';
    };

    window.exitChat = () => { document.getElementById('chat-window').style.display = 'none'; document.getElementById('init-screen').style.display = 'block'; partnerUid = ""; };
    window.logout = () => { localStorage.clear(); location.reload(); };
    function listenFriends() { onValue(ref(db, `friends/${currentUid}`), (snap) => { const list = document.getElementById('friends-list'); list.innerHTML = ''; snap.forEach((child) => { const f = child.val(); const div = document.createElement('div'); div.className = 'friend-circle'; div.innerHTML = `<span>${f.name.substring(0,2).toUpperCase()}</span>`; div.onclick = () => openChat(f.name, child.key); list.appendChild(div); }); }); }
</script>
</body>
</html>
