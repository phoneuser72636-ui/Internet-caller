<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RADIOTALKER // CYBER_OS</title>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignal = window.OneSignal || [];
      OneSignal.push(function() {
        OneSignal.init({ appId: "c00af28f-f943-4a78-aa65-1629d000bbab", allowLocalhostAsSecureOrigin: true });
      });
    </script>

    <style>
        :root { --neon-pink: #ff0055; --cyber-blue: #00f2ff; --dark-bg: #050505; }
        body { background: var(--dark-bg); color: white; font-family: 'Courier New', monospace; margin: 0; overflow: hidden; text-transform: uppercase; }
        
        /* CRT Scanline Overlay */
        .scanlines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 4px, 3px 100%; pointer-events: none; z-index: 100; }

        .os-container { height: 100vh; display: flex; flex-direction: column; border: 4px solid var(--neon-pink); box-sizing: border-box; box-shadow: 0 0 20px rgba(255, 0, 85, 0.3); }
        
        /* Auth Overlay */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark-bg); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; border: 4px solid var(--cyber-blue); }
        
        .header { padding: 10px; border-bottom: 2px solid var(--neon-pink); display: flex; justify-content: space-between; font-size: 14px; background: rgba(255, 0, 85, 0.1); }
        #video-feed { width: 100%; height: 30vh; background: #000; object-fit: cover; border-bottom: 2px solid var(--cyber-blue); }
        
        .main-ui { flex: 1; padding: 15px; overflow-y: auto; display: none; flex-direction: column; gap: 15px; }
        
        input { background: rgba(0,0,0,0.8); border: 1px solid var(--cyber-blue); color: var(--cyber-blue); padding: 12px; outline: none; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        button { background: transparent; color: var(--neon-pink); border: 2px solid var(--neon-pink); padding: 12px; font-weight: 900; cursor: pointer; transition: 0.3s; box-shadow: 0 0 10px var(--neon-pink); width: 100%; }
        button:hover { background: var(--neon-pink); color: black; box-shadow: 0 0 30px var(--neon-pink); }
        
        #chat-window { display: none; background: #000; border: 2px solid var(--cyber-blue); height: 30vh; flex-direction: column; margin-top: 10px; }
        #messages { flex: 1; overflow-y: auto; padding: 10px; font-size: 12px; }
        .msg { margin-bottom: 5px; border-left: 2px solid; padding-left: 5px; }
        .msg.me { border-color: var(--cyber-blue); color: var(--cyber-blue); }
        .msg.them { border-color: var(--neon-pink); color: var(--neon-pink); }

        .request-item { background: rgba(0, 242, 255, 0.1); border: 1px solid var(--cyber-blue); padding: 8px; margin-top: 5px; display: flex; justify-content: space-between; align-items: center; font-size: 10px; }
    </style>
</head>
<body>

<div class="scanlines"></div>

<div id="auth-overlay">
    <h2 style="color: var(--neon-pink); text-shadow: 0 0 10px var(--neon-pink);">IDENTITY_ACCESS</h2>
    <input type="text" id="auth-user" placeholder="USERNAME">
    <input type="password" id="auth-pass" placeholder="PASSWORD">
    <button onclick="handleAuth()">SIGN IN / CREATE ACCOUNT</button>
    <p id="auth-status" style="font-size: 10px; color: var(--cyber-blue); margin-top: 10px;"></p>
</div>

<div class="os-container">
    <div class="header">
        <span>RADIO_TALKER</span>
        <span id="user-display">---</span>
    </div>

    <video id="video-feed" autoplay muted playsinline></video>

    <div class="main-ui" id="main-interface">
        <input type="text" id="target-user" placeholder="ENTER FRIEND USERNAME">
        <button onclick="sendFriendRequest()">ADD FRIEND</button>

        <div id="request-list">
            <div style="font-size: 10px; color: #555;">PENDING REQUESTS:</div>
        </div>

        <div id="chat-section" style="display:none;">
            <div style="font-size: 10px; color: var(--cyber-blue);">CHAT_WITH: <span id="chat-partner">---</span></div>
            <div id="chat-window" style="display:flex;">
                <div id="messages"></div>
                <div style="display:flex; border-top:1px solid var(--cyber-blue);">
                    <input type="text" id="msg-input" placeholder="MESSAGE..." style="margin:0; border:none;">
                    <button onclick="sendMessage()" style="border:none; padding:10px; width:80px;">SEND</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD2WRzWp0pl2niRizDPF_kqUrHB4_gY8gA",
        authDomain: "radio-c49c0.firebaseapp.com",
        databaseURL: "https://radio-c49c0-default-rtdb.firebaseio.com",
        projectId: "radio-c49c0",
        messagingSenderId: "231017755170",
        appId: "1:231017755170:web:02df1616290fe2edcdd07b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let currentUid = "";
    let currentUsername = "";
    let partnerUid = "";

    onAuthStateChanged(auth, (user) => { if (!user) signInAnonymously(auth); });

    // Username & Password System
    window.handleAuth = async () => {
        const user = document.getElementById('auth-user').value.toLowerCase().trim();
        const pass = document.getElementById('auth-pass').value.trim();
        const status = document.getElementById('auth-status');

        if (!user || !pass) return status.innerText = "ENTER DETAILS";
        
        const userRef = ref(db, `users/${user}`);
        const snapshot = await get(userRef);

        if (snapshot.exists()) {
            if (snapshot.val().password === pass) {
                login(user, snapshot.val().uid);
            } else {
                status.innerText = "WRONG PASSWORD OR USERNAME TAKEN";
            }
        } else {
            // New User Registration
            const newUid = auth.currentUser.uid;
            await set(userRef, { uid: newUid, password: pass });
            await set(ref(db, `uids/${newUid}`), { username: user });
            login(user, newUid);
        }
    };

    function login(username, uid) {
        currentUsername = username;
        currentUid = uid;
        document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('main-interface').style.display = 'flex';
        document.getElementById('user-display').innerText = username;
        listenForRequests();
        window.OneSignal.push(() => OneSignal.setExternalUserId(uid));
    }

    // Friend Request Logic
    window.sendFriendRequest = async () => {
        const target = document.getElementById('target-user').value.toLowerCase().trim();
        const targetSnap = await get(ref(db, `users/${target}`));
        
        if(!targetSnap.exists()) return alert("USER NOT FOUND");
        const targetUid = targetSnap.val().uid;

        set(ref(db, `requests/${targetUid}/${currentUid}`), { from: currentUsername, fromUid: currentUid });
        
        fetch("https://onesignal.com/api/v1/notifications", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                app_id: "c00af28f-f943-4a78-aa65-1629d000bbab", //
                include_external_user_ids: [targetUid],
                headings: {"en": "NEW REQUEST"},
                contents: {"en": `${currentUsername} wants to talk.`}
            })
        });
    };

    function listenForRequests() {
        onValue(ref(db, `requests/${currentUid}`), (snapshot) => {
            const list = document.getElementById('request-list');
            list.innerHTML = '<div style="font-size: 10px; color: #555;">PENDING REQUESTS:</div>';
            snapshot.forEach((child) => {
                const req = child.val();
                const div = document.createElement('div');
                div.className = 'request-item';
                div.innerHTML = `<span>FROM: ${req.from}</span> <button style="width:auto; padding:5px;" onclick="accept('${req.from}', '${req.fromUid}')">ACCEPT</button>`;
                list.appendChild(div);
            });
        });
    }

    window.accept = (name, uid) => {
        partnerUid = uid;
        remove(ref(db, `requests/${currentUid}/${uid}`));
        document.getElementById('chat-section').style.display = 'block';
        document.getElementById('chat-partner').innerText = name;
        startChat(uid);
    };

    // Chat Functions
    function startChat(id) {
        const chatId = currentUid < id ? `${currentUid}_${id}` : `${id}_${currentUid}`;
        onValue(ref(db, `chats/${chatId}`), (snapshot) => {
            const msgBox = document.getElementById('messages');
            msgBox.innerHTML = '';
            snapshot.forEach((child) => {
                const m = child.val();
                const div = document.createElement('div');
                div.className = m.sender === currentUid ? 'msg me' : 'msg them';
                div.innerText = `> ${m.text}`;
                msgBox.appendChild(div);
            });
            msgBox.scrollTop = msgBox.scrollHeight;
        });
    }

    window.sendMessage = () => {
        const text = document.getElementById('msg-input').value;
        if(!text || !partnerUid) return;
        const chatId = currentUid < partnerUid ? `${currentUid}_${partnerUid}` : `${partnerUid}_${currentUid}`;
        push(ref(db, `chats/${chatId}`), { sender: currentUid, text: text, time: serverTimestamp() });
        document.getElementById('msg-input').value = '';
    };

    navigator.mediaDevices.getUserMedia({ video: true }).then(s => document.getElementById('video-feed').srcObject = s);
</script>

</body>
</html>
