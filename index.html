<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CYBER_PROTOCOL // FINAL</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root { --neon: #00f2ff; --warn: #ff0055; --safe: #00ff88; --void: #050505; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--void); color: var(--neon); font-family: 'Courier New', monospace; overflow: hidden; }

        /* --- GLOBAL FX --- */
        .scanline { position: fixed; inset: 0; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%); background-size: 100% 4px; pointer-events: none; z-index: 9999; }
        #purge-fx { display: none; position: fixed; inset: 0; z-index: 5000; animation: glitch 0.15s infinite; background: white; }
        @keyframes glitch { 0% { background: var(--warn); transform: skew(10deg); } 50% { background: var(--neon); transform: skew(-10deg); } 100% { background: #000; } }

        /* --- AUTH GATE (LOGIN) --- */
        #auth-gate { position: fixed; inset: 0; background: #000; z-index: 4000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .auth-box { width: 100%; max-width: 350px; border: 1px solid var(--neon); padding: 30px; box-shadow: 0 0 30px rgba(0, 242, 255, 0.2); text-align: center; background: #000; }
        .input-field { width: 100%; padding: 15px; margin-bottom: 15px; background: #111; border: 1px solid #333; color: var(--neon); font-family: inherit; font-size: 16px; transition: 0.3s; }
        .input-field:focus { border-color: var(--neon); box-shadow: 0 0 10px rgba(0, 242, 255, 0.3); }
        .btn-main { width: 100%; padding: 15px; background: var(--neon); color: #000; font-weight: bold; border: none; cursor: pointer; font-size: 16px; letter-spacing: 2px; }
        .error-msg { color: var(--warn); font-size: 12px; margin-top: 15px; min-height: 15px; }

        /* --- MAIN LAYOUT (MOBILE OPTIMIZED) --- */
        #app-shell { position: relative; width: 100vw; height: 100vh; overflow: hidden; display: none; } /* Hidden until login success */

        /* SIDEBAR (User List) - Takes Full Screen on Mobile */
        #sidebar { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; display: flex; flex-direction: column; }
        .header { padding: 20px; border-bottom: 1px solid var(--neon); display: flex; justify-content: space-between; align-items: center; background: #080808; height: 70px; flex-shrink: 0; }
        #user-list { flex: 1; overflow-y: auto; padding: 10px; }
        .user-node { padding: 20px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .user-node:active { background: #111; }
        .status-dot { width: 8px; height: 8px; background: #444; border-radius: 50%; box-shadow: 0 0 5px #444; }
        .status-dot.online { background: var(--safe); box-shadow: 0 0 8px var(--safe); }
        
        /* WORKSPACE (Chat) - Off-screen by default */
        #workspace { position: absolute; top: 0; left: 100%; width: 100%; height: 100%; background: #050505; z-index: 200; transition: left 0.3s ease-in-out; display: flex; flex-direction: column; }
        #workspace.active { left: 0; } /* Slides in */

        /* CHAT HEADER */
        .chat-head { padding: 10px 15px; border-bottom: 1px solid var(--neon); background: #080808; display: flex; align-items: center; gap: 15px; height: 70px; flex-shrink: 0; }
        .btn-back { background: none; border: 1px solid var(--neon); color: var(--neon); padding: 5px 15px; font-weight: bold; font-size: 14px; }
        .chat-info { flex: 1; text-align: center; }
        .btn-purge { background: none; border: 1px solid var(--warn); color: var(--warn); padding: 5px 10px; font-size: 12px; }

        /* CHAT AREA */
        #chat-flow { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; background: radial-gradient(circle at center, #0a0a0a 0%, #000 100%); }
        .msg { max-width: 80%; padding: 12px 16px; border: 1px solid #333; position: relative; word-wrap: break-word; font-size: 14px; }
        .sent { align-self: flex-end; border-right: 3px solid var(--neon); background: rgba(0, 242, 255, 0.05); }
        .received { align-self: flex-start; border-left: 3px solid var(--warn); color: var(--warn); }
        .meta { font-size: 9px; opacity: 0.6; text-align: right; margin-top: 5px; display: flex; justify-content: flex-end; gap: 5px; }
        .tick { color: var(--safe); display: none; }
        .tick.seen { display: inline; }

        /* INPUT AREA */
        #input-deck { padding: 10px; background: #000; border-top: 1px solid var(--neon); display: flex; gap: 10px; align-items: center; height: 70px; flex-shrink: 0; }
        .btn-icon { width: 45px; height: 45px; border: 1px solid #333; color: var(--neon); background: #111; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        #msg-input { flex: 1; height: 45px; background: #0a0a0a; border: 1px solid var(--neon); color: var(--neon); padding: 0 15px; font-family: inherit; }
        .btn-send { height: 45px; padding: 0 20px; background: var(--neon); color: #000; font-weight: bold; border: none; }

        /* MEDIA PREVIEW */
        .media-content { max-width: 100%; border: 1px solid #333; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="scanline"></div>
    <div id="purge-fx"></div>

    <div id="auth-gate">
        <div class="auth-box">
            <h2 style="letter-spacing: 4px; margin-bottom: 20px;">SYSTEM_ACCESS</h2>
            <input type="text" id="u_name" class="input-field" placeholder="IDENTITY">
            <input type="password" id="p_word" class="input-field" placeholder="PASSPHRASE">
            <button class="btn-main" onclick="attemptLogin()">INITIALIZE_LINK</button>
            <div id="login-status" class="error-msg"></div>
        </div>
    </div>

    <div id="app-shell">
        
        <div id="sidebar">
            <div class="header">
                <span>ACTIVE_NODES</span>
                <button onclick="logout()" style="color: var(--warn); background: none; border: 1px solid var(--warn); font-size: 10px; padding: 5px;">LOGOUT</button>
            </div>
            <div id="user-list"></div>
            <div style="padding: 15px; text-align: center; font-size: 10px; opacity: 0.5;">
                LOCAL_ID: <span id="my-id"></span>
            </div>
        </div>

        <div id="workspace">
            <div class="chat-head">
                <button class="btn-back" onclick="exitChat()">BACK</button>
                <div class="chat-info">
                    <span id="target-name" style="font-weight: bold; font-size: 16px;">...</span>
                    <span id="typing-notify" style="display: block; font-size: 9px; color: var(--safe); height: 10px;"></span>
                </div>
                <button class="btn-purge" onclick="reqPurge()">PURGE</button>
            </div>

            <div id="chat-flow"></div>

            <div id="input-deck">
                <button class="btn-icon" onclick="document.getElementById('file-up').click()">+</button>
                <input type="text" id="msg-input" placeholder="ENCRYPTED_DATA..." oninput="handleTyping()">
                <button class="btn-send" onclick="sendMsg()">SEND</button>
            </div>
            <input type="file" id="file-up" style="display: none;" onchange="handleFile(this)">
        </div>
    </div>

    <script>
        const socket = io();
        const AES_KEY = "CYBER_ELITE_KEY"; 
        let me = null;
        let target = null;
        let typeTimer;

        // --- AUTH LOGIC (STRICT) ---
        
        // Check Auto-Login on Load
        window.onload = () => {
            const saved = localStorage.getItem('cyber_session');
            if(saved) {
                const creds = JSON.parse(saved);
                // Try auto-login
                socket.emit('login_attempt', creds);
                document.getElementById('login-status').innerText = "VERIFYING_SESSION...";
            }
        };

        function attemptLogin() {
            const u = document.getElementById('u_name').value.trim();
            const p = document.getElementById('p_word').value.trim();
            if(!u || !p) return;

            // Security: Hash Password BEFORE sending
            const hash = CryptoJS.SHA256(p).toString();
            const creds = { user: u, pass_hash: hash };
            
            document.getElementById('login-status').innerText = "AUTHENTICATING...";
            socket.emit('login_attempt', creds);
        }

        // Server Response Listeners (THE GATEKEEPERS)
        socket.on('login_success', (data) => {
            me = data.user;
            // Save valid session
            localStorage.setItem('cyber_session', JSON.stringify({ user: me, pass_hash: data.pass_hash }));
            
            // Unlock UI
            document.getElementById('auth-gate').style.display = 'none';
            document.getElementById('app-shell').style.display = 'block'; // Show app
            document.getElementById('my-id').innerText = me;
            
            // Request User List
            socket.emit('get_users');
        });

        socket.on('login_fail', () => {
            document.getElementById('login-status').innerText = "ACCESS_DENIED: INVALID_CREDENTIALS";
            localStorage.removeItem('cyber_session');
        });

        function logout() {
            localStorage.removeItem('cyber_session');
            window.location.reload();
        }

        // --- NAVIGATION ---
        function enterChat(node) {
            target = node;
            document.getElementById('target-name').innerText = node;
            document.getElementById('workspace').classList.add('active'); // Slide in
            socket.emit('join_chat', { from: me, to: target });
        }

        function exitChat() {
            document.getElementById('workspace').classList.remove('active'); // Slide out
            target = null;
        }

        // --- MESSAGING ---
        function sendMsg() {
            const box = document.getElementById('msg-input');
            const txt = box.value.trim();
            if(!txt || !target) return;

            const packet = {
                id: 'msg_' + Date.now(),
                from: me,
                to: target,
                content: CryptoJS.AES.encrypt(txt, AES_KEY).toString(),
                type: 'text',
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            };

            socket.emit('send_msg', packet);
            renderMsg(packet, true);
            box.value = '';
        }

        function handleFile(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const packet = {
                    id: 'media_' + Date.now(),
                    from: me,
                    to: target,
                    content: CryptoJS.AES.encrypt(e.target.result, AES_KEY).toString(),
                    type: 'media',
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                };
                socket.emit('send_msg', packet);
                renderMsg(packet, true);
            };
            reader.readAsDataURL(file);
        }

        function renderMsg(pkt, isMe) {
            const flow = document.getElementById('chat-flow');
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'sent' : 'received'}`;
            div.id = pkt.id;
            
            let decrypted = CryptoJS.AES.decrypt(pkt.content, AES_KEY).toString(CryptoJS.enc.Utf8);
            
            // Media Handling
            if(decrypted.startsWith('data:image')) {
                div.innerHTML = `<img src="${decrypted}" class="media-content" onclick="window.open(this.src)">`;
            } else if (decrypted.startsWith('data:video')) {
                div.innerHTML = `<video src="${decrypted}" controls class="media-content"></video>`;
            } else {
                div.innerText = decrypted;
            }

            // Meta (Time + Ticks)
            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.innerHTML = `${pkt.time} ${isMe ? '<span class="tick">✓✓</span>' : ''}`;
            div.appendChild(meta);
            
            flow.appendChild(div);
            flow.scrollTop = flow.scrollHeight;

            if(!isMe && pkt.from === target) {
                socket.emit('mark_read', { msg_id: pkt.id, to: pkt.from });
            }
        }

        // --- REAL-TIME EVENTS ---
        socket.on('receive_msg', (pkt) => {
            if(target === pkt.from) {
                renderMsg(pkt, false);
            } else {
                // Show notification dot on user list (logic here)
            }
        });

        socket.on('msg_read', (data) => {
            const el = document.querySelector(`#${data.msg_id} .tick`);
            if(el) el.classList.add('seen');
        });

        // Typing
        function handleTyping() {
            socket.emit('typing', { to: target, user: me });
            clearTimeout(typeTimer);
            typeTimer = setTimeout(() => socket.emit('stop_typing', { to: target }), 1000);
        }
        socket.on('display_typing', (data) => {
            if(target === data.user) document.getElementById('typing-notify').innerText = "DECRYPTING_DATA...";
        });
        socket.on('hide_typing', () => {
            document.getElementById('typing-notify').innerText = "";
        });

        // Purge
        function reqPurge() {
            if(confirm("CONFIRM: NUCLEAR WIPE?")) {
                socket.emit('purge_req', { from: me, to: target });
            }
        }
        socket.on('execute_purge', () => {
            document.getElementById('purge-fx').style.display = 'block';
            setTimeout(() => {
                document.getElementById('chat-flow').innerHTML = '';
                document.getElementById('purge-fx').style.display = 'none';
            }, 2000);
        });

        // User List
        socket.on('update_users', (users) => {
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            users.forEach(u => {
                if(u.name === me) return;
                const div = document.createElement('div');
                div.className = 'user-node';
                div.innerHTML = `<span>${u.name}</span> <span class="status-dot ${u.online ? 'online' : ''}"></span>`;
                div.onclick = () => enterChat(u.name);
                list.appendChild(div);
            });
        });
    </script>
</body>
</html>
