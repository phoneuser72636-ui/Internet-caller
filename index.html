<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RADIOTALKER // CYBER_OS</title>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignal = window.OneSignal || [];
      OneSignal.push(function() {
        OneSignal.init({ 
            appId: "c00af28f-f943-4a78-aa65-1629d000bbab", 
            allowLocalhostAsSecureOrigin: true 
        });
      });
    </script>

    <style>
        :root { --neon-pink: #ff0055; --cyber-blue: #00f2ff; --dark-bg: #050505; }
        body { background: var(--dark-bg); color: white; font-family: 'Courier New', monospace; margin: 0; overflow: hidden; text-transform: uppercase; }
        
        /* CRT Scanline Overlay */
        .scanlines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 4px, 3px 100%; pointer-events: none; z-index: 100; opacity: 0.3; }

        .os-container { height: 100vh; display: flex; flex-direction: column; border: 4px solid var(--neon-pink); box-sizing: border-box; box-shadow: 0 0 20px rgba(255, 0, 85, 0.3); animation: pulse 4s infinite alternate; }
        @keyframes pulse { from { box-shadow: 0 0 10px var(--neon-pink); } to { box-shadow: 0 0 20px var(--cyber-blue); border-color: var(--cyber-blue); } }

        /* Identity Access Overlay */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark-bg); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; border: 4px solid var(--cyber-blue); }
        
        .header { padding: 10px; border-bottom: 2px solid var(--neon-pink); display: flex; justify-content: space-between; font-size: 12px; background: rgba(255, 0, 85, 0.1); }
        #video-feed { width: 100%; height: 25vh; background: #000; object-fit: cover; border-bottom: 2px solid var(--cyber-blue); filter: contrast(1.2) brightness(1.1); }
        
        .main-ui { flex: 1; padding: 15px; overflow-y: auto; display: none; flex-direction: column; gap: 10px; }
        
        input { background: rgba(0,0,0,0.8); border: 1px solid var(--cyber-blue); color: var(--cyber-blue); padding: 12px; outline: none; width: 100%; box-sizing: border-box; margin-bottom: 8px; font-family: 'Courier New', monospace; font-size: 14px; }
        button { background: transparent; color: var(--neon-pink); border: 2px solid var(--neon-pink); padding: 12px; font-weight: 900; cursor: pointer; transition: 0.3s; box-shadow: 0 0 10px var(--neon-pink); width: 100%; font-family: 'Courier New', monospace; text-transform: uppercase; }
        button:hover { background: var(--neon-pink); color: black; box-shadow: 0 0 30px var(--neon-pink); }
        
        /* Connections & Chat */
        #friends-list { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        .friend-btn { border-color: var(--cyber-blue); color: var(--cyber-blue); box-shadow: 0 0 5px var(--cyber-blue); font-size: 10px; padding: 8px; }
        
        #chat-section { background: #000; border: 2px solid var(--cyber-blue); height: 35vh; display: none; flex-direction: column; margin-top: 5px; box-shadow: 0 0 15px rgba(0, 242, 255, 0.2); }
        #messages { flex: 1; overflow-y: auto; padding: 10px; font-size: 11px; }
        .msg { margin-bottom: 6px; border-left: 2px solid; padding-left: 8px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .msg.me { border-color: var(--cyber-blue); color: var(--cyber-blue); }
        .msg.them { border-color: var(--neon-pink); color: var(--neon-pink); }

        .request-item { background: rgba(0, 242, 255, 0.1); border: 1px solid var(--cyber-blue); padding: 8px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; font-size: 10px; border-radius: 2px; }
    </style>
</head>
<body>

<div class="scanlines"></div>

<div id="auth-overlay">
    <h2 style="color: var(--neon-pink); text-shadow: 0 0 15px var(--neon-pink); letter-spacing: 3px;">IDENTITY_ACCESS</h2>
    <input type="text" id="auth-user" placeholder="SELECT_USERNAME">
    <input type="password" id="auth-pass" placeholder="SECURITY_KEY">
    <button onclick="handleAuth()">SIGN_IN // INITIALIZE</button>
    <p id="auth-status" style="font-size: 10px; color: var(--cyber-blue); margin-top: 15px; font-weight: bold;"></p>
</div>

<div class="os-container">
    <div class="header">
        <span style="letter-spacing: 2px;">RADIOTALKER // v1.0</span>
        <span id="user-display" style="color: var(--cyber-blue); text-shadow: 0 0 5px var(--cyber-blue);">OFFLINE</span>
    </div>

    <video id="video-feed" autoplay muted playsinline></video>

    <div class="main-ui" id="main-interface">
        <input type="text" id="target-user" placeholder="ENTER_TARGET_USERNAME">
        <button onclick="sendFriendRequest()">TRANSMIT_ADD_SIGNAL</button>

        <div id="request-list">
            <div style="font-size: 10px; color: #666; margin: 8px 0;">INCOMING_SIGNALS:</div>
        </div>

        <div style="font-size: 10px; color: var(--cyber-blue); margin-top: 8px; border-top: 1px solid #333; padding-top: 5px;">STABILIZED_UPLINKS:</div>
        <div id="friends-list"></div>

        <div id="chat-section">
            <div style="font-size: 10px; padding: 6px; border-bottom: 1px solid var(--cyber-blue); background: rgba(0, 242, 255, 0.05);">
                UPLINK_ACTIVE: <span id="chat-partner" style="color: var(--cyber-blue);">---</span>
            </div>
            <div id="messages"></div>
            <div style="display:flex; border-top:1px solid var(--cyber-blue);">
                <input type="text" id="msg-input" placeholder="TYPE_MESSAGE..." style="margin:0; border:none; font-size: 11px; flex: 1;">
                <button onclick="sendMessage()" style="border:none; padding:10px; width:85px; box-shadow:none; font-size: 11px;">SEND</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Your verified Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyD2WRzWp0pl2niRizDPF_kqUrHB4_gY8gA",
        authDomain: "radio-c49c0.firebaseapp.com",
        databaseURL: "https://radio-c49c0-default-rtdb.firebaseio.com",
        projectId: "radio-c49c0",
        storageBucket: "radio-c49c0.firebasestorage.app",
        messagingSenderId: "231017755170",
        appId: "1:231017755170:web:02df1616290fe2edcdd07b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let currentUid = "";
    let currentUsername = "";
    let partnerUid = "";

    // Automatic Anonymous Login for unique ID persistence
    onAuthStateChanged(auth, (user) => { if (!user) signInAnonymously(auth); });

    // 1. AUTH SYSTEM
    window.handleAuth = async () => {
        const user = document.getElementById('auth-user').value.toLowerCase().trim();
        const pass = document.getElementById('auth-pass').value.trim();
        const status = document.getElementById('auth-status');

        if (!user || !pass) return status.innerText = "> ERROR: INCOMPLETE_DATA";
        status.innerText = "> SCANNING_IDENTITY...";
        
        const userRef = ref(db, `users/${user}`);
        const snapshot = await get(userRef);

        if (snapshot.exists()) {
            if (snapshot.val().password === pass) {
                login(user, snapshot.val().uid);
            } else {
                status.innerText = "> ERROR: USERNAME_TAKEN_OR_PASS_WRONG";
            }
        } else {
            const newUid = auth.currentUser.uid;
            await set(userRef, { uid: newUid, password: pass });
            await set(ref(db, `uids/${newUid}`), { username: user });
            login(user, newUid);
        }
    };

    function login(username, uid) {
        currentUsername = username;
        currentUid = uid;
        document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('main-interface').style.display = 'flex';
        document.getElementById('user-display').innerText = `ID: ${username.toUpperCase()}`;
        
        listenForRequests();
        listenForFriends(); 
        window.OneSignal.push(() => OneSignal.setExternalUserId(uid));
    }

    // 2. FRIEND REQUESTS
    window.sendFriendRequest = async () => {
        const target = document.getElementById('target-user').value.toLowerCase().trim();
        if (target === currentUsername) return alert("SELF_CONNECTION_BLOCKED");
        
        const targetSnap = await get(ref(db, `users/${target}`));
        if(!targetSnap.exists()) return alert("TARGET_NOT_FOUND");
        
        const targetUid = targetSnap.val().uid;
        set(ref(db, `requests/${targetUid}/${currentUid}`), { from: currentUsername, fromUid: currentUid });
        
        // Pocket Notification
        fetch("https://onesignal.com/api/v1/notifications", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                app_id: "c00af28f-f943-4a78-aa65-1629d000bbab", 
                include_external_user_ids: [targetUid],
                headings: {"en": "INCOMING_SIGNAL"},
                contents: {"en": `${currentUsername} is requesting uplink.`}
            })
        });
        alert("SIGNAL_TRANSMITTED");
    };

    function listenForRequests() {
        onValue(ref(db, `requests/${currentUid}`), (snapshot) => {
            const list = document.getElementById('request-list');
            list.innerHTML = '<div style="font-size: 10px; color: #666; margin: 8px 0;">INCOMING_SIGNALS:</div>';
            snapshot.forEach((child) => {
                const req = child.val();
                const div = document.createElement('div');
                div.className = 'request-item';
                div.innerHTML = `<span>USER: ${req.from}</span> <button style="width:auto; padding:5px 12px; font-size:9px;" onclick="accept('${req.from}', '${req.fromUid}')">ACCEPT</button>`;
                list.appendChild(div);
            });
        });
    }

    // 3. MULTI-USER FRIEND LIST & PERSISTENCE
    window.accept = async (name, uid) => {
        await set(ref(db, `friends/${currentUid}/${uid}`), { name: name });
        await set(ref(db, `friends/${uid}/${currentUid}`), { name: currentUsername });
        remove(ref(db, `requests/${currentUid}/${uid}`));
    };

    function listenForFriends() {
        onValue(ref(db, `friends/${currentUid}`), (snapshot) => {
            const list = document.getElementById('friends-list');
            list.innerHTML = '';
            snapshot.forEach((child) => {
                const f = child.val();
                const btn = document.createElement('button');
                btn.className = 'friend-btn';
                btn.innerText = `CONNECT_TO: ${f.name.toUpperCase()}`;
                btn.onclick = () => switchToChat(f.name, child.key);
                list.appendChild(btn);
            });
        });
    }

    // 4. PRIVATE CHAT LOGIC
    function switchToChat(name, uid) {
        partnerUid = uid;
        document.getElementById('chat-section').style.display = 'flex';
        document.getElementById('chat-partner').innerText = name.toUpperCase();
        startChat(uid);
    }

    function startChat(id) {
        const chatId = currentUid < id ? `${currentUid}_${id}` : `${id}_${currentUid}`;
        onValue(ref(db, `chats/${chatId}`), (snapshot) => {
            const msgBox = document.getElementById('messages');
            msgBox.innerHTML = '';
            snapshot.forEach((child) => {
                const m = child.val();
                const div = document.createElement('div');
                div.className = m.sender === currentUid ? 'msg me' : 'msg them';
                div.innerText = `> ${m.text}`;
                msgBox.appendChild(div);
            });
            msgBox.scrollTop = msgBox.scrollHeight;
        });
    }

    window.sendMessage = () => {
        const text = document.getElementById('msg-input').value;
        if(!text || !partnerUid) return;
        const chatId = currentUid < partnerUid ? `${currentUid}_${partnerUid}` : `${partnerUid}_${currentUid}`;
        push(ref(db, `chats/${chatId}`), { sender: currentUid, text: text, time: serverTimestamp() });
        document.getElementById('msg-input').value = '';
    };

    // Camera Feed
    navigator.mediaDevices.getUserMedia({ video: true }).then(s => document.getElementById('video-feed').srcObject = s);
</script>

</body>
</html>
