<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYBER_PROTOCOL // V2.0</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root { --neon-cyan: #00f2ff; --neon-magenta: #ff00ff; --matrix-green: #00ff88; --dark-depth: #050505; --sidebar-w: 260px; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--dark-depth); color: var(--neon-cyan); font-family: 'Share Tech Mono', monospace; overflow: hidden; }
        .scanline { position: fixed; inset: 0; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%); background-size: 100% 4px; pointer-events: none; z-index: 100; }
        
        /* Auth Gate */
        #auth-gate { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: black; z-index: 1000; }
        .gate-box { border: 1px solid var(--neon-cyan); padding: 40px; box-shadow: 0 0 25px rgba(0, 242, 255, 0.4); text-align: center; background: #000; }

        /* Main Layout */
        #main-ui { display: none; height: 100vh; display: flex; }
        
        /* Sidebar */
        #sidebar { width: var(--sidebar-w); border-right: 1px solid var(--neon-cyan); display: flex; flex-direction: column; background: rgba(0,0,0,0.9); }
        .sidebar-header { padding: 15px; border-bottom: 1px solid var(--neon-cyan); font-weight: bold; }
        #user-list { flex: 1; overflow-y: auto; padding: 10px; }
        .user-node { padding: 12px; margin-bottom: 5px; border: 1px solid rgba(0, 242, 255, 0.2); cursor: pointer; transition: 0.3s; }
        .user-node:hover, .user-node.active { background: rgba(0, 242, 255, 0.1); border-color: var(--neon-cyan); }
        
        /* Chat Area */
        #chat-window { flex: 1; display: flex; flex-direction: column; background-image: linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px); background-size: 40px 40px; }
        #chat-header { padding: 15px; border-bottom: 1px solid var(--neon-cyan); display: flex; justify-content: space-between; align-items: center; background: #000; }
        #chat-flow { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        /* Messaging */
        .msg { padding: 12px; border: 1px solid rgba(0, 242, 255, 0.3); max-width: 70%; position: relative; }
        .sent { align-self: flex-end; border-right: 4px solid var(--neon-cyan); }
        .received { align-self: flex-start; border-left: 4px solid var(--neon-magenta); color: var(--neon-magenta); border-color: var(--neon-magenta); }
        
        /* Controls */
        input { background: #000; border: 1px solid var(--neon-cyan); color: var(--neon-cyan); padding: 12px; font-family: inherit; }
        button { background: var(--neon-cyan); color: #000; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        .logout-btn { background: none; border: 1px solid #ff4d4d; color: #ff4d4d; margin-top: 10px; }
        .purge-btn { border: 1px solid var(--neon-magenta); color: var(--neon-magenta); background: none; }

        /* FX */
        #purge-fx { display: none; position: fixed; inset: 0; z-index: 2000; animation: glitch 0.1s infinite; }
        @keyframes glitch { 0% { background: #f0f; clip-path: inset(10% 0 30% 0); } 50% { background: #0ff; clip-path: inset(30% 0 10% 0); } 100% { background: #000; } }
    </style>
</head>
<body>
    <div class="scanline"></div>
    <div id="purge-fx"></div>

    <div id="auth-gate">
        <div class="gate-box">
            <h2 id="gate-title">SYSTEM_ACCESS_REQUIRED</h2>
            <input type="text" id="username" placeholder="USERNAME"><br><br>
            <input type="password" id="password" placeholder="PASSWORD"><br><br>
            <button onclick="handleAuth()">INITIALIZE_LINK</button>
        </div>
    </div>

    <div id="main-ui">
        <div id="sidebar">
            <div class="sidebar-header">ACTIVE_NODES</div>
            <div id="user-list"></div>
            <div style="padding: 10px; border-top: 1px solid var(--neon-cyan);">
                <div id="my-name" style="font-size: 12px; margin-bottom: 5px;"></div>
                <button class="logout-btn" style="width: 100%;" onclick="logout()">TERMINATE_SESSION</button>
            </div>
        </div>

        <div id="chat-window">
            <div id="chat-header">
                <span id="target-node">SELECT_REMOTE_NODE</span>
                <button class="purge-btn" onclick="triggerPurge()">PURGE_CHANNEL</button>
            </div>
            <div id="chat-flow"></div>
            <div id="typing-box" style="height:20px; font-size:10px; padding: 0 20px; color: var(--matrix-green);"></div>
            <div style="padding: 20px; display: flex; gap: 10px; background: #000;">
                <input type="text" id="msg-input" placeholder="ENCRYPT_DATA..." style="flex:1;">
                <button onclick="sendData()">DISPATCH</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const PASSKEY = "AES_SECRET_V2";
        let currentUser = null;
        let activeTarget = null;

        // Auto-Login Check
        window.onload = () => {
            const saved = localStorage.getItem('cyber_session');
            if(saved) {
                currentUser = JSON.parse(saved);
                bootUI();
            }
        };

        async function handleAuth() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            if(!user || !pass) return;

            // Password Hashing for Security
            const hash = CryptoJS.SHA256(pass).toString();
            currentUser = { username: user, token: hash };
            localStorage.setItem('cyber_session', JSON.stringify(currentUser));
            bootUI();
        }

        function bootUI() {
            document.getElementById('auth-gate').style.display = 'none';
            document.getElementById('main-ui').style.display = 'flex';
            document.getElementById('my-name').innerText = `ID: ${currentUser.username}`;
            socket.emit('node_join', { user: currentUser.username });
            loadUsers(); // Logic to fetch other registered users
        }

        function logout() {
            localStorage.removeItem('cyber_session');
            window.location.reload();
        }

        // Messaging logic
        function sendData() {
            const input = document.getElementById('msg-input');
            if(!input.value || !activeTarget) return;

            const packet = {
                id: 'pkt_' + Date.now(),
                sender: currentUser.username,
                target: activeTarget,
                data: CryptoJS.AES.encrypt(input.value, PASSKEY).toString()
            };

            socket.emit('private_dispatch', packet);
            appendMsg(packet, true);
            input.value = '';
        }

        function appendMsg(pkt, isSelf) {
            const flow = document.getElementById('chat-flow');
            const div = document.createElement('div');
            div.className = `msg ${isSelf ? 'sent' : 'received'}`;
            
            const decrypted = CryptoJS.AES.decrypt(pkt.data, PASSKEY).toString(CryptoJS.enc.Utf8);
            div.innerHTML = decrypted;
            
            flow.appendChild(div);
            flow.scrollTop = flow.scrollHeight;
        }

        function triggerPurge() {
            if(!activeTarget) return;
            socket.emit('purge_request', { from: currentUser.username, to: activeTarget });
        }

        socket.on('execute_glitch', () => {
            document.getElementById('purge-fx').style.display = 'block';
            setTimeout(() => {
                document.getElementById('chat-flow').innerHTML = '';
                document.getElementById('purge-fx').style.display = 'none';
            }, 2000);
        });

        // Demo User Loading (In real app, fetch from SQL)
        function loadUsers() {
            const list = document.getElementById('user-list');
            const users = ['System_Admin', 'Nexus_7', 'Ghost_User']; // Replace with SQL fetch
            users.forEach(u => {
                const div = document.createElement('div');
                div.className = 'user-node';
                div.innerText = u;
                div.onclick = () => {
                    activeTarget = u;
                    document.getElementById('target-node').innerText = `CHANNEL: ${u}`;
                    document.querySelectorAll('.user-node').forEach(n => n.classList.remove('active'));
                    div.classList.add('active');
                };
                list.appendChild(div);
            });
        }
    </script>
</body>
</html>
