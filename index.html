<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYBER_PROTOCOL // ELITE_V3</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root { --neon: #00f2ff; --warn: #ff0055; --safe: #00ff88; --void: #050505; --side-w: 280px; }
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--void); color: var(--neon); font-family: 'Courier New', monospace; overflow: hidden; }
        .scanline { position: fixed; inset: 0; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%); background-size: 100% 4px; pointer-events: none; z-index: 999; }
        
        /* Auth Layer */
        #auth-gate { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: #000; z-index: 1000; }
        .auth-box { border: 1px solid var(--neon); padding: 50px; box-shadow: 0 0 30px rgba(0, 242, 255, 0.3); background: #000; text-align: center; }

        /* Main Shell */
        #main-shell { display: none; height: 100vh; display: flex; }
        
        /* Sidebar (User List) */
        #sidebar { width: var(--side-w); border-right: 1px solid var(--neon); display: flex; flex-direction: column; background: rgba(0,0,0,0.95); }
        .side-head { padding: 20px; border-bottom: 1px solid var(--neon); font-weight: bold; letter-spacing: 2px; }
        #node-list { flex: 1; overflow-y: auto; padding: 10px; }
        .node { padding: 15px; margin-bottom: 8px; border: 1px solid rgba(0, 242, 255, 0.1); cursor: pointer; display: flex; align-items: center; transition: 0.2s; }
        .node:hover, .node.active { background: rgba(0, 242, 255, 0.1); border-color: var(--neon); box-shadow: inset 0 0 10px rgba(0, 242, 255, 0.2); }
        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 12px; }
        .online { background: var(--safe); box-shadow: 0 0 8px var(--safe); }
        .offline { background: #444; }

        /* Chat Workspace */
        #workspace { flex: 1; display: flex; flex-direction: column; background-image: radial-gradient(rgba(0, 242, 255, 0.05) 1px, transparent 0); background-size: 30px 30px; }
        #work-head { padding: 15px 25px; border-bottom: 1px solid var(--neon); display: flex; justify-content: space-between; align-items: center; background: #000; }
        #chat-stream { flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; gap: 15px; }
        
        /* Bubbles */
        .msg { padding: 12px 18px; border: 1px solid rgba(0, 242, 255, 0.2); max-width: 65%; position: relative; backdrop-filter: blur(5px); }
        .sent { align-self: flex-end; border-right: 4px solid var(--neon); background: rgba(0, 242, 255, 0.05); }
        .received { align-self: flex-start; border-left: 4px solid var(--warn); color: var(--warn); border-color: var(--warn); }
        .unsend-trigger { color: #ff4d4d; font-size: 10px; cursor: pointer; margin-top: 5px; display: block; }

        /* Input Deck */
        #input-deck { padding: 20px; background: #000; border-top: 1px solid var(--neon); display: flex; gap: 12px; }
        input { background: #000; border: 1px solid var(--neon); color: var(--neon); padding: 14px; font-family: inherit; outline: none; }
        button { background: var(--neon); color: #000; border: none; padding: 10px 25px; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        .purge-btn { background: none; border: 1px solid var(--warn); color: var(--warn); }
        .logout-btn { background: none; border: 1px solid #777; color: #777; width: 100%; margin-top: 10px; }

        /* Purge Animation */
        #purge-overlay { display: none; position: fixed; inset: 0; z-index: 2000; animation: glitch-purge 0.15s infinite; }
        @keyframes glitch-purge { 0% { background: var(--warn); clip-path: inset(20% 0 40% 0); } 50% { background: var(--neon); transform: scale(1.05); } 100% { background: #000; } }
    </style>
</head>
<body>
    <div class="scanline"></div>
    <div id="purge-overlay"></div>

    <div id="auth-gate">
        <div class="auth-box">
            <h1 style="letter-spacing: 5px;">ANONYMOUS_GATE</h1>
            <input type="text" id="username" placeholder="NODE_ID" style="width: 100%;"><br><br>
            <input type="password" id="password" placeholder="SECRET_PHRASE" style="width: 100%;"><br><br>
            <button onclick="auth()" style="width: 100%;">INITIALIZE_CONNECTION</button>
        </div>
    </div>

    <div id="main-shell">
        <div id="sidebar">
            <div class="side-head">SECURE_NODES</div>
            <div id="node-list"></div>
            <div style="padding: 15px;">
                <div id="my-identity" style="font-size: 11px; opacity: 0.6;"></div>
                <button class="logout-btn" onclick="terminate()">LOGOUT_SYSTEM</button>
            </div>
        </div>

        <div id="workspace">
            <div id="work-head">
                <span id="active-node-name">WAITING_FOR_LINK...</span>
                <button class="purge-btn" onclick="requestPurge()">PURGE_SESSION</button>
            </div>
            <div id="chat-stream"></div>
            <div id="typing-indicator" style="height:20px; font-size:10px; padding:0 30px; color: var(--safe);"></div>
            <div id="input-deck">
                <input type="text" id="main-input" placeholder="TYPE_ENCRYPTED_PACKET..." style="flex:1;" oninput="emitTyping()">
                <button onclick="dispatch()">DISPATCH</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const AES_KEY = "PROTOCOL_ZERO_V3";
        let userState = null;
        let currentTarget = null;
        let typeTimer;

        // Auto-Login Sequence
        window.onload = () => {
            const session = localStorage.getItem('cyber_v3_session');
            if(session) {
                userState = JSON.parse(session);
                enterSystem();
            }
        };

        function auth() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(!u || !p) return;

            // Password Transformation (SHA-256)
            const securePass = CryptoJS.SHA256(p).toString();
            userState = { id: u, token: securePass };
            localStorage.setItem('cyber_v3_session', JSON.stringify(userState));
            enterSystem();
        }

        function enterSystem() {
            document.getElementById('auth-gate').style.display = 'none';
            document.getElementById('main-shell').style.display = 'flex';
            document.getElementById('my-identity').innerText = `LOCAL_NODE: ${userState.id}`;
            socket.emit('node_join', { user: userState.id });
            syncNodes(); 
        }

        function terminate() {
            localStorage.removeItem('cyber_v3_session');
            window.location.reload();
        }

        // Messaging Core
        function dispatch() {
            const box = document.getElementById('main-input');
            if(!box.value || !currentTarget) return;

            const packet = {
                pid: 'p_' + Date.now(),
                from: userState.id,
                to: currentTarget,
                payload: CryptoJS.AES.encrypt(box.value, AES_KEY).toString()
            };

            socket.emit('secure_dispatch', packet);
            render(packet, true);
            box.value = '';
        }

        function render(pkt, isMe) {
            const stream = document.getElementById('chat-stream');
            const el = document.createElement('div');
            el.id = pkt.pid;
            el.className = `msg ${isMe ? 'sent' : 'received'}`;
            
            let data = CryptoJS.AES.decrypt(pkt.payload, AES_KEY).toString(CryptoJS.enc.Utf8);
            
            // Media Processor
            if(data.match(/\.(jpg|jpeg|png|gif)$/i)) data = `<img src="${data}" style="max-width:100%; border:1px solid var(--neon)">`;
            else if(data.match(/\.(mp4|webm)$/i)) data = `<video src="${data}" controls style="max-width:100%"></video>`;

            const unsend = isMe ? `<span class="unsend-trigger" onclick="unsend('${pkt.pid}')">[PURGE_MSG]</span>` : '';
            el.innerHTML = data + unsend;
            
            stream.appendChild(el);
            stream.scrollTop = stream.scrollHeight;
        }

        // Feature: Immediate Unsend
        function unsend(pid) { socket.emit('msg_kill_req', { pid: pid }); }
        socket.on('msg_killed', (d) => { document.getElementById(d.pid)?.remove(); });

        // Feature: Typing State
        function emitTyping() {
            socket.emit('node_typing', { user: userState.id, to: currentTarget });
            clearTimeout(typeTimer);
            typeTimer = setTimeout(() => socket.emit('node_typing_stop', { to: currentTarget }), 1500);
        }
        socket.on('node_typing_ui', (d) => { document.getElementById('typing-indicator').innerText = `${d.user} is accessing buffer...`; });
        socket.on('node_typing_stop_ui', () => { document.getElementById('typing-indicator').innerText = ''; });

        // Feature: Mutual Purge
        function requestPurge() {
            if(currentTarget) socket.emit('purge_channel_req', { u1: userState.id, u2: currentTarget });
        }
        socket.on('trigger_glitch_purge', () => {
            document.getElementById('purge-overlay').style.display = 'block';
            setTimeout(() => {
                document.getElementById('chat-stream').innerHTML = '';
                document.getElementById('purge-overlay').style.display = 'none';
            }, 2000);
        });

        // User Directory Logic
        function syncNodes() {
            const list = document.getElementById('node-list');
            const demoNodes = ['Alpha_Node', 'Delta_6', 'Ghost_Link']; // Replace with your Python server user fetch
            demoNodes.forEach(nodeID => {
                const d = document.createElement('div');
                d.className = 'node';
                d.innerHTML = `<span class="dot online"></span> ${nodeID}`;
                d.onclick = () => {
                    currentTarget = nodeID;
                    document.getElementById('active-node-name').innerText = `CHANNEL: ${nodeID}`;
                    document.querySelectorAll('.node').forEach(n => n.classList.remove('active'));
                    d.classList.add('active');
                };
                list.appendChild(d);
            });
        }
    </script>
</body>
</html>
