<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RADIOTALKER // CYBER_OS</title>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignal = window.OneSignal || [];
      OneSignal.push(function() {
        OneSignal.init({ appId: "c00af28f-f943-4a78-aa65-1629d000bbab", allowLocalhostAsSecureOrigin: true });
      });
    </script>

    <style>
        :root { --pink: #ff0055; --blue: #00f2ff; --bg: #050505; --glow: 0 0 15px var(--pink); }
        
        body { 
            background: black url('https://wallpaperaccess.com/full/1324706.jpg') no-repeat center center fixed; 
            background-size: cover; color: white; font-family: 'Courier New', monospace; margin: 0; overflow: hidden; 
        }
        
        /* CRT Scanline & Glitch Vibe */
        .scanlines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%); background-size: 100% 4px; pointer-events: none; z-index: 100; opacity: 0.3; }

        .os-container { 
            height: 100vh; display: grid; grid-template-columns: 220px 1fr; border: 4px solid var(--pink); 
            box-sizing: border-box; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
            animation: borderPulse 4s infinite alternate;
        }
        @keyframes borderPulse { from { border-color: var(--pink); } to { border-color: var(--blue); } }
        
        /* Sidebar */
        .sidebar { border-right: 2px solid var(--pink); display: flex; flex-direction: column; padding: 15px; background: rgba(255, 0, 85, 0.05); }
        .sidebar h3 { font-size: 11px; color: var(--blue); border-bottom: 1px solid var(--blue); padding-bottom: 10px; letter-spacing: 2px; }
        .friend-item { display: flex; align-items: center; padding: 12px; border: 1px solid transparent; cursor: pointer; transition: 0.3s; margin-bottom: 8px; font-size: 13px; background: rgba(0,0,0,0.5); }
        .friend-item:hover { border-color: var(--blue); box-shadow: 0 0 10px var(--blue); transform: scale(1.02); }
        
        /* Status Dots */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 12px; }
        .online { background: #00ff00; box-shadow: 0 0 8px #00ff00; }
        .offline { background: #ff0000; box-shadow: 0 0 8px #ff0000; }

        /* Auth & Header */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .header { grid-column: 1 / span 2; padding: 12px; border-bottom: 2px solid var(--pink); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.9); }
        .logout-btn { color: var(--pink); border: 1px solid var(--pink); padding: 5px 12px; font-size: 11px; cursor: pointer; font-weight: bold; }

        /* Main UI & Controls */
        .main-content { display: flex; flex-direction: column; overflow-y: auto; padding: 20px; gap: 15px; }
        video { width: 100%; height: 28vh; background: #000; border: 2px solid var(--blue); object-fit: cover; box-shadow: 0 0 15px rgba(0, 242, 255, 0.2); }
        input { background: rgba(0,0,0,0.8); border: 1px solid var(--blue); color: var(--blue); padding: 14px; outline: none; font-family: 'Courier New'; font-size: 14px; }
        
        .cyber-btn { background: transparent; color: var(--pink); border: 2px solid var(--pink); padding: 14px; font-weight: bold; cursor: pointer; box-shadow: var(--glow); text-transform: uppercase; transition: 0.2s; position: relative; overflow: hidden; }
        .cyber-btn:hover { background: var(--pink); color: black; box-shadow: 0 0 30px var(--pink); }
        .ringtone-btn { color: var(--blue); border-color: var(--blue); box-shadow: 0 0 10px var(--blue); font-size: 11px; margin-top: 5px; }

        #chat-window { display: none; flex-direction: column; border: 2px solid var(--blue); height: 35vh; background: rgba(0,0,0,0.9); }
        #messages { flex: 1; overflow-y: auto; padding: 12px; font-size: 12px; }
        .msg { margin-bottom: 8px; border-left: 2px solid; padding-left: 8px; }
        .msg.me { border-color: var(--blue); color: var(--blue); }
        .msg.them { border-color: var(--pink); color: var(--pink); }
    </style>
</head>
<body>

<div class="scanlines"></div>

<div id="auth-overlay">
    <h1 style="color: var(--pink); text-shadow: 0 0 15px var(--pink); letter-spacing: 5px;">IDENTITY_ACCESS</h1>
    <input type="text" id="auth-user" placeholder="ENTER_USERNAME">
    <input type="password" id="auth-pass" placeholder="SECURITY_PHRASE">
    <button class="cyber-btn" onclick="handleAuth()">INITIALIZE_SYSTEM</button>
</div>

<div class="os-container">
    <div class="header">
        <span style="color: var(--blue); letter-spacing: 2px;">RADIOTALKER // CYBER_OS</span>
        <div>
            <span id="user-display" style="margin-right:20px; font-size:12px; color: var(--blue);">STATUS: OFFLINE</span>
            <span class="logout-btn" onclick="logout()">TERMINATE_SESSION</span>
        </div>
    </div>

    <div class="sidebar">
        <h3>ACTIVE_UPLINKS</h3>
        <div id="friends-list"></div>
        
        <div style="margin-top:auto;">
            <input type="file" id="ringtone-input" accept="audio/*" style="display:none;" onchange="saveRingtone(this)">
            <button class="cyber-btn ringtone-btn" onclick="document.getElementById('ringtone-input').click()">PICK RINGTONE</button>
        </div>
    </div>

    <div class="main-content" id="main-interface" style="display:none;">
        <video id="video-feed" autoplay muted playsinline></video>
        
        <input type="text" id="target-user" placeholder="TARGET_USERNAME">
        <button class="cyber-btn" onclick="sendFriendRequest()">TRANSMIT_ADD_SIGNAL</button>

        <div id="request-list"></div>

        <div id="chat-window">
            <div style="font-size: 11px; padding: 8px; border-bottom: 1px solid var(--blue); background: rgba(0, 242, 255, 0.1);">
                CONNECTED_CHANNEL: <span id="partner-name">---</span>
            </div>
            <div id="messages"></div>
            <div style="display:flex; border-top:1px solid var(--blue);">
                <input type="text" id="msg-input" placeholder="ENCRYPTED_MESSAGE..." style="margin:0; border:none; flex:1;">
                <button onclick="sendMessage()" style="border:none; width:90px; color: var(--blue); background: rgba(0, 242, 255, 0.1);">SEND</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue, remove, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD2WRzWp0pl2niRizDPF_kqUrHB4_gY8gA",
        authDomain: "radio-c49c0.firebaseapp.com",
        databaseURL: "https://radio-c49c0-default-rtdb.firebaseio.com",
        projectId: "radio-c49c0",
        messagingSenderId: "231017755170",
        appId: "1:231017755170:web:02df1616290fe2edcdd07b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let currentUid = "", currentUsername = "", partnerUid = "";
    let ringtone = new Audio();

    onAuthStateChanged(auth, (user) => { if (!user) signInAnonymously(auth); });

    // 1. AUTO-LOGIN
    window.onload = () => {
        const u = localStorage.getItem('rt_user'), p = localStorage.getItem('rt_pass');
        const r = localStorage.getItem('rt_ring');
        if (r) ringtone.src = r;
        if (u && p) { document.getElementById('auth-user').value = u; document.getElementById('auth-pass').value = p; handleAuth(); }
    };

    window.handleAuth = async () => {
        const user = document.getElementById('auth-user').value.toLowerCase().trim();
        const pass = document.getElementById('auth-pass').value.trim();
        const userRef = ref(db, `users/${user}`);
        const snap = await get(userRef);

        if (snap.exists() && snap.val().password !== pass) return alert("SIGNAL_REJECTED: AUTH_FAILED");
        
        const uid = snap.exists() ? snap.val().uid : auth.currentUser.uid;
        if (!snap.exists()) await set(userRef, { uid, password: pass });
        
        localStorage.setItem('rt_user', user); localStorage.setItem('rt_pass', pass);
        login(user, uid);
    };

    function login(username, uid) {
        currentUsername = username; currentUid = uid;
        document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('main-interface').style.display = 'flex';
        document.getElementById('user-display').innerText = `USER: ${username.toUpperCase()}`;
        
        // Presence Tracker
        const statusRef = ref(db, `status/${uid}`);
        onDisconnect(statusRef).set({ state: "offline", last: serverTimestamp() });
        set(statusRef, { state: "online", last: serverTimestamp() });

        listenForRequests(); listenForFriends();
        window.OneSignal.push(() => OneSignal.setExternalUserId(uid));
    }

    // 2. RINGTONE LOGIC
    window.saveRingtone = (input) => {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            localStorage.setItem('rt_ring', e.target.result);
            ringtone.src = e.target.result;
            alert("RINGTONE_SYNCED");
        };
        reader.readAsDataURL(file);
    };

    // 3. PERSISTENT FRIENDS & STATUS
    window.sendFriendRequest = async () => {
        const target = document.getElementById('target-user').value.toLowerCase().trim();
        const tSnap = await get(ref(db, `users/${target}`));
        if(!tSnap.exists()) return alert("SIGNAL_LOST: TARGET_NOT_FOUND");
        set(ref(db, `requests/${tSnap.val().uid}/${currentUid}`), { from: currentUsername, fromUid: currentUid });
    };

    function listenForFriends() {
        onValue(ref(db, `friends/${currentUid}`), (snapshot) => {
            const list = document.getElementById('friends-list'); list.innerHTML = '';
            snapshot.forEach((child) => {
                const f = child.val();
                const item = document.createElement('div');
                item.className = 'friend-item';
                item.innerHTML = `<div id="dot-${child.key}" class="status-dot offline"></div> <span>${f.name}</span>`;
                item.onclick = () => openChat(f.name, child.key);
                list.appendChild(item);
                
                onValue(ref(db, `status/${child.key}`), (s) => {
                    const dot = document.getElementById(`dot-${child.key}`);
                    if(dot) dot.className = `status-dot ${s.val()?.state === 'online' ? 'online' : 'offline'}`;
                });
            });
        });
    }

    window.accept = async (name, uid) => {
        await set(ref(db, `friends/${currentUid}/${uid}`), { name });
        await set(ref(db, `friends/${uid}/${currentUid}`), { name: currentUsername });
        remove(ref(db, `requests/${currentUid}/${uid}`));
    };

    // 4. CHAT & CALL PUSH
    function openChat(name, uid) {
        partnerUid = uid; document.getElementById('chat-window').style.display = 'flex';
        document.getElementById('partner-name').innerText = name.toUpperCase();
        
        // Ring via OneSignal
        fetch("https://onesignal.com/api/v1/notifications", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                app_id: "c00af28f-f943-4a78-aa65-1629d000bbab",
                include_external_user_ids: [uid],
                priority: 10,
                headings: {"en": "INCOMING UPLINK"},
                contents: {"en": `${currentUsername} is calling you...`},
                android_accent_color: "ff0055"
            })
        });

        const chatId = currentUid < uid ? `${currentUid}_${uid}` : `${uid}_${currentUid}`;
        onValue(ref(db, `chats/${chatId}`), (s) => {
            const box = document.getElementById('messages'); box.innerHTML = '';
            s.forEach((m) => {
                const d = document.createElement('div');
                d.className = m.val().sender === currentUid ? 'msg me' : 'msg them';
                d.innerText = `> ${m.val().text}`; box.appendChild(d);
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    window.sendMessage = () => {
        const text = document.getElementById('msg-input').value; if(!text || !partnerUid) return;
        const chatId = currentUid < partnerUid ? `${currentUid}_${partnerUid}` : `${partnerUid}_${currentUid}`;
        push(ref(db, `chats/${chatId}`), { sender: currentUid, text, time: serverTimestamp() });
        document.getElementById('msg-input').value = '';
    };

    window.listenForRequests = () => {
        onValue(ref(db, `requests/${currentUid}`), (snapshot) => {
            const list = document.getElementById('request-list'); list.innerHTML = '';
            snapshot.forEach((child) => {
                const r = child.val();
                if(ringtone.src) ringtone.play(); // Play custom ringtone on request
                const div = document.createElement('div'); div.style.fontSize='11px'; div.style.color='var(--blue)';
                div.innerHTML = `REQ: ${r.from} <button onclick="accept('${r.from}','${r.fromUid}')" style="padding:2px; font-size:9px;">ACCEPT</button>`;
                list.appendChild(div);
            });
        });
    }

    window.logout = () => { set(ref(db, `status/${currentUid}`), { state: "offline" }); localStorage.clear(); location.reload(); };

    navigator.mediaDevices.getUserMedia({ video: true }).then(s => document.getElementById('video-feed').srcObject = s);
</script>

</body>
</html>
